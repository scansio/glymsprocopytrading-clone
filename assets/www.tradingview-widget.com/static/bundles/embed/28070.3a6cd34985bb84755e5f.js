"use strict";(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[28070],{265046:(e,t,s)=>{function r(e,t){return{start:Math.min(e.start,t.start),end:Math.max(e.end,t.end)}}function i(e){return void 0===e?e:Array.from(e)}s.d(t,{arrayFromSet:()=>i,mergeTpoPriceRanges:()=>r})},328070:(e,t,s)=>{s.d(t,{TpoStudyBase:()=>O,extendingInputIds:()=>B});var r=s(283873),i=s(650151),o=s(444372),a=s(735566),l=s(418450),n=s(422063),c=s(605071),d=s(905520),u=s(870855),p=s(68777),h=s(553407);const{colorColdGray200:m,colorColdGray900:g,colorDeepBlueA200:S,colorDeepBlueA700:_,colorGrapesPurpleA200Alpha15:w,colorSkyBlue400Alpha50:y,colorSkyBlue400Alpha75:P}=h.colors,A={poc:[g,m],poorHigh:[_,S],poorLow:[_,S],singleprints:[w,w],vah:[g,m],val:[g,m],values:[g,m],vpVah:[g,m],vpVal:[g,m],vpPoc:[g,m],volumeColor:[y,y],valueAreaColor:[P,P]};var b=s(51196),v=s(746142),T=s(265046),C=s(414986),R=s(600653),M=s(885935);class f extends C.SummaryPaneView{constructor(e,t){super(e,t)}_cutOffLastColumn(){return!1}_getDataSourceForSummary(){return this._model.dataSourceForId(M.tpoSummaryDataSourceId)}_getSummaryColumnRendererData(e,t){const s=this._study.graphics(),r=this._model.timeScale(),i=this._study,o=this._model.mainSeries().properties().childs().tpoStyle.childs(),a=o.summary.childs().infoBlocks.childs(),l=o.levels.childs().initialBalanceRange.childs(),n=new b.VolumeFormatter,c=this._model.mainSeries().formatter(),d=e=>c.format(e),u=new v.LogicalRange(t.left()-5,t.right()+5),p=[],h=.5*r.barSpacing();for(const[t,o]of s.tpos()){const c=s.tpoSummaryInfo().get(t);Array.from(o).sort(((e,t)=>e.firstBarTime-t.firstBarTime)).forEach((o=>{if(!u.contains(o.firstBarTime)&&!u.contains(o.lastBarTime))return;const m=Array.from(c?.get(o.id)??[]),g=m[m.length-1];if(!g)return;const{initialBalanceHigh:S,initialBalanceLow:_,initialBalanceRange:w}=a,y={vahPrice:d(g.vahPrice),valPrice:d(g.valPrice),pocPrice:d(g.pocPrice)},P=S.childs().visible.value(),A=_.childs().visible.value(),b=w.childs().visible.value();if(P||A||b){const e=(0,T.arrayFromSet)(s.tpoBlockSets().get(t)?.get(o.id));if(void 0!==e){const t=i.calculateInitialBalancePriceRange(e,o.priceRange,l);y.initialBalanceHigh=t?d(t.end):"—",y.initialBalanceLow=t?d(t.start):"—",y.initialBalanceRange=t?d(t.end-t.start):"—"}}y.rotationFactor=g.rotationFactor.toString(),y.hlRange=d(g.hlRange),y.vaRange=d(g.vaRange),y.totalVolume=n.format(g.totalVolume),y.tpoCountTotal=g.tpoCountTotal.toString(),y.tpoCountAbovePoc=g.tpoCountAbovePoc.toString(),y.tpoCountBelowPoc=g.tpoCountBelowPoc.toString();const v=R.tpoRowTitles.map((e=>e.propName)).filter((e=>a[e].childs().visible.value())).map((e=>({text:y[e]}))),C=r.indexToCoordinate(o.firstBarTime)-h,M=Math.round(C*e.horizontalPixelRatio),f=r.indexToCoordinate(o.lastBarTime)+h,V=Math.round(f*e.horizontalPixelRatio);p.push({left:M,right:V,rows:v})}))}return p}}var V=s(304550);class k extends V.SummaryWidgetSideAreaView{_getDataSourceForSummary(){return this._model.dataSourceForId(M.tpoSummaryDataSourceId)}_visibleTitles(){
const e=this._model.mainSeries().properties().childs().tpoStyle.childs().summary.childs().infoBlocks.childs();return R.tpoRowTitles.filter((t=>e[t.propName].childs().visible.value())).map((e=>e.translatedString.translatedText()))}}const B=["extendPoorLow","extendPoorHigh","extendPOC","extendTpoVah","extendTpoVal","extendVolumePoc","extendVolumeVah","extendVolumeVal","extendSingleprints"],x=(0,a.getLogger)("Chart.TpoStudyBase");class I extends n.UndoCommand{constructor(e,t,r,i){super(new l.TranslatedString("TPO Reset all splits and merges",o.t(null,void 0,s(602966)))),this._model=e,this._id=t,this._splitsAndMerges=r,this._keyFilter=i}redo(){const e=structuredClone(this._splitsAndMerges);Object.keys(e).filter(this._keyFilter).forEach((t=>{delete e[t]})),this._study().setSplitsAndMerges(e)}undo(){this._study().setSplitsAndMerges(this._splitsAndMerges)}_study(){return(0,i.ensureNotNull)(this._model.dataSourceForId(this._id))}}function N(e,t){return t<e}class O extends c.Study{constructor(e,t,s,r,i,o,a,l=I){B.forEach((e=>t.removeExcludedKey(`inputs.${e}`,1))),super(e,t,s,r,i,o),this._autoTickPerRowData=null,this._splitsAndMerges={},this._histogramIsTooLargeCounter=0,this._lastResolvedProName=null,this._onSeriesCompletedChanged=e=>{e&&(this._seriesCompleted.unsubscribe(this._onSeriesCompletedChanged),this._tryCalculateTickPerRow())},this._summaryPaneView=new f(this,e),this._widgetSideAreaView=new k(e),this._seriesCompleted=(0,p.combine)((e=>u.seriesReadyStatuses.has(e.seriesStatus)),e.mainSeries().compositeStatusVW().weakReference()),this._chartStyleMode=!!a,a&&this._properties.setNameInOwner(""),this._resetAllSplitsUndoCommandCtor=l,t.childs().styles.hasChild("splitByBlocks")||t.childs().styles.addChild("splitByBlocks",new d.Property(!1)),t.childs().styles.hasChild("splitByBlocksMode")||t.childs().styles.addChild("splitByBlocksMode",new d.Property(0));const n="graphics.tpoLevels.tpo",c="graphics.tpoVolumeRows.tpo";t.setThemedColors([{path:`${n}.tpoPoc.color`,colors:A.poc},{path:`${n}.tpoPoorHigh.color`,colors:A.poorHigh},{path:`${n}.tpoPoorLow.color`,colors:A.poorLow},{path:`${n}.tpoSingleprints.color`,colors:A.singleprints},{path:`${n}.tpoVah.color`,colors:A.vah},{path:`${n}.tpoVal.color`,colors:A.val},{path:`${n}.volumeVah.color`,colors:A.vpVah},{path:`${n}.volumeVal.color`,colors:A.vpVal},{path:`${n}.volumePoc.color`,colors:A.vpPoc},{path:`${c}.valuesColor`,colors:A.values},{path:`${c}.colors.nonVa`,colors:A.volumeColor},{path:`${c}.colors.va`,colors:A.valueAreaColor}]);const h=e.mainSeries(),m=this._properties.childs().inputs.childs();if(this.splitMergeSupported()){h.symbolResolved().subscribe(this,this._applySplitAndMerges),h.properties().childs().symbol.subscribe(this,this._applySplitAndMerges);const e=m.mergePoints;this._updateSplitsAndMergesActionsValue(e.value()),this._splitsAndMergesInputsDeps().forEach((e=>{m[e]?.subscribe(this,this._applySplitAndMerges)})),e.subscribe(this,(()=>{const t=e.value()??"[]";"[]"===t?this._removeSplitsAndMergesActionsValue():this._updateSplitsAndMergesActionsValue(t)}))}
const g=()=>{this._autoTickPerRowData=null,this._tryCalculateTickPerRow()},S=()=>{const e=this.properties().childs().inputs.childs();"Auto"===e.rowSize.value()&&e.ticksPerRow.setValue(NaN),this._autoTickPerRowData=null,this._seriesCompleted.unsubscribe(this._onSeriesCompletedChanged),this._seriesCompleted.subscribe(this._onSeriesCompletedChanged,{once:!0}),this._histogramIsTooLargeCounter=0};m.rowSize.subscribe(this,g),this.properties().onRestoreFactoryDefaults().subscribe(this,g),h.symbolResolved().subscribe(this,(()=>{const e=h.symbolInfo()?.pro_name??null;this._lastResolvedProName!==e&&(this._lastResolvedProName=e,S())})),h.properties().childs().symbol.subscribe(this,S),h.onIntervalChanged().subscribe(this,S),this._tryCalculateTickPerRow(),this._properties.addExcludedKey("inputs.mergePoints",1)}destroy(){const e=this._model.mainSeries();this._seriesCompleted.unsubscribe(this._onSeriesCompletedChanged),this._seriesCompleted.destroy(),e.symbolResolved().unsubscribeAll(this),e.properties().childs().symbol.unsubscribeAll(this),e.onIntervalChanged().unsubscribeAll(this),this._widgetSideAreaView.destroy(),this._properties.destroy(),super.destroy()}updateAllViews(e){super.updateAllViews(e),this._summaryPaneView.update(),this._widgetSideAreaView.update()}preferredZOrder(){return 0}stateCustomFields(){return{autoTickPerRowData:this._autoTickPerRowData??void 0,splitsAndMerges:this._splitsAndMerges}}restoreStateCustomFields(e){this._autoTickPerRowData=e.autoTickPerRowData??null,this.splitMergeSupported()&&(this._splitsAndMerges=e.splitsAndMerges??{},this._applySplitAndMerges())}resetAllSplitsAndMerges(){const e=this._model.undoModel(),t=new this._resetAllSplitsUndoCommandCtor(this._model,this.id(),structuredClone(this._splitsAndMerges),this._resetSplitsAndMergesKeyFilter.bind(this));e.undoHistory().pushUndoCommand(t)}setSplitsAndMerges(e){this._splitsAndMerges=e,this._applySplitAndMerges()}splitBlock(e){this._appendMergeSplitAction(e,"split",new l.TranslatedString("TPO split block",o.t(null,void 0,s(955277))))}mergeProfile(e){this._appendMergeSplitAction(e,"merge",new l.TranslatedString("TPO merge block",o.t(null,void 0,s(106174))))}calculateInitialBalancePriceRange(e,t,s){let r=null;const i=s.levels.value(),o=N.bind(null,i);for(const s of e){const e={start:s.rowIndex*t,end:(s.rowIndex+1)*t};s.blocks.some(o)&&(r=null===r?e:(0,T.mergeTpoPriceRanges)(r,e))}return r}paneViews(e){return this._chartStyleMode?e!==this._model.mainPane()?[this._summaryPaneView]:this._paneViews:super.paneViews(e)}widgetSideAreaViews(e){const t=this._model.mainSeries().priceScale();if(!t)return null;const s=this._model.mainPane();if(!s)return null;const r=s.priceScalePosition(t);return this._chartStyleMode&&e===r?[this._widgetSideAreaView]:null}priceScale(){return this._chartStyleMode?this._model.mainSeries().priceScale():super.priceScale()}dataUpdated(){return this._dataUpdated}_splitsAndMergesActionsKey(){return""}_resetSplitsAndMergesKeyFilter(e){return!1}_splitsAndMergesActionsValue(){
return this._splitsAndMerges[this._splitsAndMergesActionsKey()]??null}_updateSplitsAndMergesActionsValue(e){this._splitsAndMerges[this._splitsAndMergesActionsKey()]=e}_removeSplitsAndMergesActionsValue(){delete this._splitsAndMerges[this._splitsAndMergesActionsKey()]}_splitsAndMergesInputsDeps(){return[]}_apiInputs(){const{rowSize:e,...t}=super._apiInputs();return t}_allInputsAreValid(){const e=this.properties().childs().inputs.childs().ticksPerRow.value();return!isNaN(e)&&super._allInputsAreValid()}_autoRowSizeModeEnabled(){return"Auto"===this.properties().childs().inputs.childs().rowSize.value()}_tryCalculateTickPerRow(){if(this._autoRowSizeModeEnabled()&&(e=this._autoTickPerRowData,t=this._currentAutoTickPerRowData(),null===e||e.symbol!==t.symbol||e.interval!==t.interval)){this._calculateTickPerRow()?this._autoTickPerRowData=this._currentAutoTickPerRowData():(this._seriesCompleted.unsubscribe(this._onSeriesCompletedChanged),this._seriesCompleted.subscribe(this._onSeriesCompletedChanged,{once:!0}))}var e,t}_calculateTickPerRow(){const e=this._model.mainSeries(),t=e.symbolInfo(),s=e.data().bars();if(!s.size()||!t)return!1;const r=this._model.timeScale().visibleBarsStrictRange();if(null===r)return!1;const o=s.rangeCountback(r.lastBar(),300),a=o.minMaxOnRangeCached((0,i.ensureNotNull)(o.firstIndex()),(0,i.ensureNotNull)(o.lastIndex()),[{name:"low",offset:0},{name:"high",offset:0}]);if(null===a)return!1;const l=t.minmov/t.pricescale,n=(a.max-a.min)/l,c=Math.max(n/80,n/1e3),d=Math.pow(1.4,this._histogramIsTooLargeCounter)*c+5*this._histogramIsTooLargeCounter,u=Math.floor(Math.log10(c)),p=5*Math.max(1,Math.pow(10,u-1)),h=Math.round(d/p)*p,m=Math.min(1e6,Math.max(1,h));return this.properties().childs().inputs.childs().ticksPerRow.setValue(m),x.logInfo(`Autocalculate TicksPerRow.\n\t\t\tsymbol: ${this._series.symbol()}\n\t\t\tinterval: ${this._series.interval()}\n\t\t\tminTick: ${l}\n\t\t\thigh: ${a.max}\n\t\t\tlow: ${a.min}\n\t\t\thistogramIsTooLargeCounter: ${this._histogramIsTooLargeCounter}\n\t\t\tresult: ${m}`),!0}_currentAutoTickPerRowData(){const e=this._model.mainSeries();return{symbol:e.getSymbolString(),interval:e.interval()}}_onStudyError(e){const t=(0,r.default)(e)?e:e.error;if(this._autoRowSizeModeEnabled()&&t.startsWith("Histogram is too large")){if(++this._histogramIsTooLargeCounter<10)return x.logInfo("Recalculate ticksPerRow with multiplicator"),void this._calculateTickPerRow();x.logWarn("Recalculating ticksPerRow limit has been exceeded")}super._onStudyError(e)}_onStudyCompleted(e){x.logInfo("Reset histogramIsTooLargeCounter because of complete message"),this._histogramIsTooLargeCounter=0,super._onStudyCompleted(e)}_appendMergeSplitAction(e,t,s){const r=this._properties.childs().inputs.childs().mergePoints.value(),i=""===r||null===r?[]:JSON.parse(r);i.push({action:t,time:e}),this._model.undoModel().setProperty(this._properties.childs().inputs.childs().mergePoints,JSON.stringify(i),s)}_applySplitAndMerges(){const e=this._splitsAndMergesActionsValue()??"[]"
;this._properties.childs().inputs.childs().mergePoints.setValue(e)}}},600653:(e,t,s)=>{s.d(t,{tpoRowTitles:()=>w});var r=s(378338),i=s(418450);const o=r.t(null,{context:"TPO Summary row title, high-low range"},s(48210)),a=r.t(null,{context:"TPO Summary row title, value area range"},s(956078)),l=r.t(null,{context:"TPO Summary row title, abbr Volume area high"},s(848924)),n=r.t(null,{context:"TPO Summary row title, abbr Volume area low"},s(201788)),c=r.t(null,{context:"TPO Summary row title, abbr Point of control"},s(159888)),d=r.t(null,{context:"TPO Summary row title"},s(740497)),u=r.t(null,{context:"TPO Summary row title"},s(111485)),p=r.t(null,{context:"TPO Summary row title"},s(409293)),h=r.t(null,{context:"TPO Summary row title"},s(105012)),m=r.t(null,{context:"TPO Summary row title"},s(599855)),g=r.t(null,{context:"TPO Summary row title, abbr Initial Balance High"},s(290618)),S=r.t(null,{context:"TPO Summary row title, abbr Initial Balance Low"},s(106740)),_=r.t(null,{context:"TPO Summary row title, abbr Initial Balance Range"},s(273646)),w=[{translatedString:new i.TranslatedString("HL Range",o),propName:"hlRange"},{translatedString:new i.TranslatedString("VA range",a),propName:"vaRange"},{translatedString:new i.TranslatedString("VAH",l),propName:"vahPrice"},{translatedString:new i.TranslatedString("VAL",n),propName:"valPrice"},{translatedString:new i.TranslatedString("POC",c),propName:"pocPrice"},{translatedString:new i.TranslatedString("Total volume",d),propName:"totalVolume"},{translatedString:new i.TranslatedString("Total TPO",u),propName:"tpoCountTotal"},{translatedString:new i.TranslatedString("TPO Above POC",p),propName:"tpoCountAbovePoc"},{translatedString:new i.TranslatedString("TPO Below POC",h),propName:"tpoCountBelowPoc"},{translatedString:new i.TranslatedString("Rotation factor",m),propName:"rotationFactor"},{translatedString:new i.TranslatedString("IB high",g),propName:"initialBalanceHigh"},{translatedString:new i.TranslatedString("IB low",S),propName:"initialBalanceLow"},{translatedString:new i.TranslatedString("IB range",_),propName:"initialBalanceRange"}]}}]);