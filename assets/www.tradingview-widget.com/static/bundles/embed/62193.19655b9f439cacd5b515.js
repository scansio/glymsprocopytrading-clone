"use strict";(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[62193],{423623:(e,t,s)=>{s.d(t,{ChartSession:()=>h});var r=s(547465),i=s(650151),a=s(820028),n=s(900608);const o=(0,s(735566).getLogger)("ChartApi.AbstractSession");class l{constructor(e,t,s){this._isConnected=new a.WatchedValue(!1),this._state=0,this._isConnectForbidden=!1,this._sessionId="",this._sessionIdChanged=new r.Delegate,this._chartApi=e,this._sessionPrefix=t,this._shouldReconnectAfterCriticalError=s}destroy(){this._logNormal("Destroying session"),this._isConnected.unsubscribe(),this.disconnect(),this._sessionIdChanged.destroy(),delete this._chartApi,this._logNormal("Session has been destroyed")}isConnected(){return this._isConnected}sessionId(){return this._sessionId}onSessionIdChanged(){return this._sessionIdChanged}connect(){0===this._state&&((0,i.assert)(!this._isConnectForbidden,"Cannot call connect because it is forbidden at this moment"),this._setSessionId(`${this._sessionPrefix}_${(0,n.randomHash)()}`),this._logNormal("Connecting session - wait until transport stay connected"),this._state=1,this._chartApi.createSession(this._sessionId,this))}disconnect(){0!==this._state&&((0,i.assert)(""!==this._sessionId,"sessionId must not be invalid"),this._logNormal("Disconnecting session..."),this._forbidConnectWhile((()=>{this._chartApi.connected()&&this._sendRemoveSession(),this._processDestroyingOnServer()})))}onMessage(e){switch(e.method){case"connected":return void this._onChartApiConnected();case"disconnected":return void this._onChartApiDisconnected();case"critical_error":const t=String(e.params[0]),s=String(e.params[1]);return void this._onCriticalError(t,s)}this._onMessage(e)}serverTime(){return this._chartApi.serverTime()}_getChartApi(){return this._chartApi}_generateLogMessage(e){return`[${this._sessionId}] ${e}`}_onCriticalError(e,t){this._logError(`Critical error. Reason=${e}, info=${t}.`),this._forbidConnectWhile((()=>{this._processDestroyingOnServer()})),this._shouldReconnectAfterCriticalError?(this._logNormal("Reconnecting after critical error..."),this.connect()):this._logNormal("Reconnecting after critical error skipped")}_onChartApiConnected(){(0,i.assert)(1===this._state,"Session is not registered"),this._logNormal("Transport is connected. Creating session on the server"),this._sendCreateSession(),this._state=2,this._isConnected.setValue(!0)}_onChartApiDisconnected(){this._logNormal("Transport is disconnected. Reconnecting..."),this._forbidConnectWhile((()=>{this._processDestroyingOnServer()})),this.connect()}_setSessionId(e){const t=this._sessionId;this._logNormal(`Changing sessionId: old=${t}, new=${e}`),this._sessionId=e,this._sessionIdChanged.fire(e,t)}_logNormal(e){o.logNormal(this._generateLogMessage(e))}_logError(e){o.logError(this._generateLogMessage(e))}_processDestroyingOnServer(){this._state=0,this._isConnected.setValue(!1),this._chartApi.removeSession(this._sessionId),this._setSessionId("")}_forbidConnectWhile(e){this._isConnectForbidden=!0,e(),this._isConnectForbidden=!1}}class h extends l{
constructor(e,t=!1){super(e,"cs",!1),this._sessionDisabled=!1,this._handler=null,this._criticalError=new r.Delegate,this._symbolResolveMap=new Map,this._lastSymbolResolveInfoMap=new Map,this._disableStatistics=t}destroy(){this._criticalError.destroy(),this._handler=null,this._symbolResolveMap.clear(),super.destroy()}switchTimezone(e){return this._getChartApi().switchTimezone(this.sessionId(),e)}defaultResolutions(){return this._getChartApi().defaultResolutions()}availableCurrencies(){return this._getChartApi().availableCurrencies()}availableUnits(){return this._getChartApi().availableUnits()}availablePriceSources(e){return this._getChartApi().availablePriceSources(e)}resolveSymbol(e,t,s){if(this._symbolResolveMap.has(t)){const[e,r]=this._symbolResolveMap.get(t);return Array.isArray(r)?r.push(s):r.then(s),e}{const r=[s];return this._getChartApi().resolveSymbol(this.sessionId(),e,t,(s=>{if("symbol_error"===s.method)this._symbolResolveMap.delete(t);else{this._symbolResolveMap.set(t,[e,Promise.resolve(s)]);const[,r]=s.params,i={pro_name:r.pro_name,ticker:r.ticker};this._lastSymbolResolveInfoMap.set(t,i),i.pro_name&&this._lastSymbolResolveInfoMap.set(i.pro_name,i),r.full_name&&this._lastSymbolResolveInfoMap.set(r.full_name,i),i.ticker&&this._lastSymbolResolveInfoMap.set(i.ticker,i)}r.forEach((e=>e(s)))})),this._symbolResolveMap.set(t,[e,r]),e}}requestFirstBarTime(e,t,s){return this._getChartApi().requestFirstBarTime(this.sessionId(),e,t,s)}lastSymbolResolveInfo(e){return this._lastSymbolResolveInfoMap.get(e)??null}createSeries(e,t,s,r,i,a,n){return this._getChartApi().createSeries(this.sessionId(),e,t,s,r,i,a,n)}modifySeries(e,t,s,r,i,a,n){return this._getChartApi().modifySeries(this.sessionId(),e,t,s,r,i,a,n)}removeSeries(e){return!!this.isConnected().value()&&this._getChartApi().removeSeries(this.sessionId(),e)}requestMoreData(e,t,s){return"number"==typeof e?this._getChartApi().requestMoreData(this.sessionId(),e):this._getChartApi().requestMoreData(this.sessionId(),e,t,s)}requestMoreTickmarks(e,t,s){return this._getChartApi().requestMoreTickmarks(this.sessionId(),e,t,s)}setFutureTickmarksMode(e){return this._getChartApi().setFutureTickmarksMode(this.sessionId(),e)}canCreateStudy(e,t){return this._getChartApi().canCreateStudy(this.sessionId(),e,t)}getStudyCounter(){return this._getChartApi().getStudyCounter(this.sessionId())}getFundamentalCounter(){return this._getChartApi().getFundamentalCounter(this.sessionId())}createStudy(e,t,s,r,i,a,n){return this._getChartApi().createStudy(this.sessionId(),e,t,s,r,i,a,n)}modifyStudy(e,t,s,r,i){return this._getChartApi().modifyStudy(this.sessionId(),e,t,s,r,i)}notifyStudy(e,t,s){return this._getChartApi().notifyStudy(this.sessionId(),e,t,s)}removeStudy(e){return this._getChartApi().removeStudy(this.sessionId(),e)}createPointset(e,t,s,r,i,a){return this._getChartApi().createPointset(this.sessionId(),e,t,s,r,i,a)}modifyPointset(e,t,s,r){return this._getChartApi().modifyPointset(this.sessionId(),e,t,s,r)}removePointset(e){return this._getChartApi().removePointset(this.sessionId(),e)}
setVisibleTimeRange(e,t,s,r,i,a,n){0}criticalError(){return this._criticalError}connect(e=null){null!==e&&(this._handler=e),this._symbolResolveMap.clear(),super.connect()}setHandler(e){this._handler=e}connected(){return this.isConnected().value()&&!this._sessionDisabled}disable(){this._sessionDisabled=!0}chartApi(){return this._getChartApi()}_sendCreateSession(){Object.keys(this).forEach((e=>{/^(s|st|symbol_)\d+$/.test(e)&&delete this[e]})),this._getChartApi().chartCreateSession(this.sessionId(),this._disableStatistics)}_sendRemoveSession(){this._getChartApi().chartDeleteSession(this.sessionId())}_onMessage(e){this._handler&&this._handler(e)}_onCriticalError(e,t){this._criticalError.fire(e,t),super._onCriticalError(e,t)}}},306543:(e,t,s)=>{s.d(t,{getServerInterval:()=>i});var r=s(477786);function i(e){return r.Interval.isRange(e)?"1":e}},20019:(e,t,s)=>{s.d(t,{ConflatedChunksBuilder:()=>n});var r=s(650151),i=s(660439);const a=[{barsToMerge:10,forBarspacingLargerThen:.03},{barsToMerge:30,forBarspacingLargerThen:.01},{barsToMerge:100,forBarspacingLargerThen:.003},{barsToMerge:500,forBarspacingLargerThen:0}];class n{constructor(e,t){this._plots=e,this._conflatedChunks={chunks:new Map,priceSource:null,priceSourcesProvider:t},this._clearConflatedChunks()}conflatedChunks(e,t){if(t!==this._conflatedChunks.priceSource){this._conflatedChunks.priceSource=t;const e=this._plots.first();e&&(this._clearConflatedChunks(),this._rebuildConflatedChunks(e))}const s=(0,r.ensureDefined)(a.find((t=>t.forBarspacingLargerThen<=e)));return(0,r.ensureDefined)(this._conflatedChunks.chunks.get(s.barsToMerge))}mergeData(e){const t=this._plots.size(),s=this._plots.merge(e);return s&&null!==this._conflatedChunks.priceSource&&(t!==this._plots.size()||s.index!==this._plots.lastIndex()||function(e){let t=!0;return e.chunks.forEach((e=>{t=t&&0===e.length})),t}(this._conflatedChunks)?this._rebuildConflatedChunks(s):this._updateLatestChunks()),s}moveData(e){this._plots.move(e),this._plots.size()>0&&this._clearConflatedChunks()}clearData(){this._plots.clear(),this._clearConflatedChunks()}_rebuildConflatedChunks(e){const t=this._conflatedChunks.priceSource;if(null===t)return;const s=e.index,n=this._conflatedChunks.priceSourcesProvider(t),o=(e,t,s)=>{let r=null;for(const i of e){const e=n(i.value);r&&i.index-r.startTime>=s.barsToMerge&&(t.push(r),r=null),r?(r.endTime=i.index,r.high=Math.max(r.high,e),r.low=Math.min(r.low,e),r.close=e):r={startTime:i.index,endTime:i.index,open:e,high:e,low:e,close:e}}r&&t.push(r)};a.forEach((e=>{const t=(0,r.ensureDefined)(this._conflatedChunks.chunks.get(e.barsToMerge)),a=(0,i.lowerbound)(t,s,((e,t)=>e.endTime<t));if(0===a&&t.length>0){const s=t[0].startTime-1,i=(0,r.ensureNotNull)(this._plots.firstIndex()),a=this._plots.rangeIterator(i,s),n=[];o(a,n,e);const l=n.concat(t);this._conflatedChunks.chunks.set(e.barsToMerge,l)}else{const s=(0,r.ensureNotNull)(this._plots.lastIndex());t.splice(a);let i=(0,r.ensureNotNull)(this._plots.firstIndex());t.length&&(i=t[t.length-1].endTime+1);const n=this._plots.rangeIterator(i,s)
;o(n,t,e)}}))}_updateLatestChunks(){const e=(0,r.ensureNotNull)(this._plots.last()),t=this._conflatedChunks.priceSourcesProvider("close");a.forEach((s=>{const i=(0,r.ensureDefined)(this._conflatedChunks.chunks.get(s.barsToMerge)),a=t(e.value),n=i[i.length-1];n.high=Math.max(n.high,a),n.low=Math.min(n.low,a),n.close=a,n.endTime=e.index}))}_clearConflatedChunks(){a.forEach((e=>this._conflatedChunks.chunks.set(e.barsToMerge,[])))}}},847774:(e,t,s)=>{var r;s.d(t,{SymbolErrorPermissionDeniedReason:()=>r,invalidSymbol:()=>a,permissionDenied:()=>i}),function(e){e.Symbol="symbol",e.GroupPermission="group"}(r||(r={}));const i="permission denied",a="invalid symbol"},359035:(e,t,s)=>{s.d(t,{unpackNonSeriesData:()=>o});var r=s(130551),i=s(650151);function a(e){if(!(0,r.isObject)(e))throw new Error("Graphics commands should be wrapped in an object");if((0,r.hasProperty)(e,"create"),(0,r.hasProperty)(e,"erase")){const t=e.erase;(0,i.assert)(Array.isArray(t),"Collection of erase commands should be array");for(const e of t){if(!(0,r.isObject)(e)||!(0,r.hasProperty)(e,"action"))throw new Error("Command should be an object with 'action' property");(0,i.assert)("all"===e.action||"one"===e.action,"Erase command action should be 'all' or 'one'")}}return e}async function n(e){{const[{inflateZlib:t,inflateRaw:r},{unpackImpl:i}]=await Promise.all(["function"==typeof DecompressionStream?s.e(95465).then(s.bind(s,552243)):Promise.all([s.e(84069),s.e(82170)]).then(s.bind(s,392592)),s.e(95465).then(s.bind(s,321672))]);return i(t,r,e)}}async function o(e){if(""===e)return null;const t=JSON.parse(e);if(!(0,r.isObject)(t)||"function"==typeof t)throw new Error("Non-object content in the non-series envelope");if((0,r.hasProperty)(t,"indexes_replace"))return{indexes_replace:!0};const s={indexes_replace:!1};if((0,r.hasProperty)(t,"offsets")&&(s.offsets=t.offsets),(0,r.hasProperty)(t,"isUpdate")){if("boolean"!=typeof t.isUpdate)throw new Error('Invalid type of "isUpdate" field');s.isUpdate=t.isUpdate}return(0,r.hasProperty)(t,"data")&&(s.data=t.data),(0,r.hasProperty)(t,"graphicsCmds")&&(s.graphicsCmds=a(t.graphicsCmds)),(0,r.hasProperty)(t,"dataCompressed")&&(s.data=await n(t.dataCompressed)),(0,r.hasProperty)(t,"graphicsCmdsCompressed")&&(s.graphicsCmds=a(await n(t.graphicsCmdsCompressed))),s}},326488:(e,t,s)=>{s.d(t,{SeriesData:()=>u,barFunction:()=>d,barFunctions:()=>l,seriesPlotFunctionMap:()=>h});var r,i=s(650151),a=s(132565),n=s(20019);!function(e){e[e.FromLeft=-1]="FromLeft",e[e.FromRight=1]="FromRight"}(r||(r={}));const o=["open","high","low","close","hl2","hlc3","ohlc4"],l={open:e=>e[1],high:e=>e[2],low:e=>e[3],close:e=>e[4],hl2:e=>(e[2]+e[3])/2,hlc3:e=>(e[2]+e[3]+e[4])/3,ohlc4:e=>(e[1]+e[2]+e[3]+e[4])/4};function h(){const e=new Map;return o.forEach(((t,s)=>{e.set(t,d(t))})),e}function d(e,t,s){const r=l[t??e],i=l[e],a=l[s??e];return(e,t)=>{switch(t){case 0:return r(e);case 2:return a(e);default:return i(e)}}}function c(e,t){return null==e[t]}class u{constructor(){this.m_bars=new a.PlotList(h(),c),this.m_nsBars=new a.PlotList(h(),c),
this._conflatedChunksBuilder=new n.ConflatedChunksBuilder(this.m_bars,(e=>l[e]))}bars(){return this.m_bars}nsBars(){return this.m_nsBars}conflatedChunks(e,t){return this._conflatedChunksBuilder.conflatedChunks(e,t)}mergeRegularBars(e){return this._conflatedChunksBuilder.mergeData(e)}size(){return this.m_bars.size()+this.m_nsBars.size()}each(e){this.m_bars.each(e),this.m_nsBars.each(e)}clear(){this.m_nsBars.clear(),this.lastProjectionPrice=void 0,this._conflatedChunksBuilder.clearData()}clone(){const e=new u;return e.lastProjectionPrice=this.lastProjectionPrice,e.boxSize=this.boxSize,e.reversalAmount=this.reversalAmount,e.m_bars=this.m_bars.clone(),e.m_nsBars=this.m_bars.clone(),e}isEmpty(){return this.m_bars.isEmpty()&&this.m_nsBars.isEmpty()}first(){return this.m_bars.isEmpty()?this.m_nsBars.first():this.m_bars.first()}last(){return this.m_nsBars.isEmpty()?this.m_bars.last():this.m_nsBars.last()}search(e,t,s){return this.nsBars().isEmpty()?this.bars().search(e,t,s):this.bars().isEmpty()||(0,i.ensureNotNull)(this.nsBars().firstIndex())<=e?this.nsBars().search(e,t,s):this.bars().search(e,t,s)}valueAt(e){const t=this.search(e);return null!==t?t.value:null}plotValueToTimePointIndex(e,t,s){if(s===r.FromRight){const s=(s,r)=>{const i=r[t];return null!=i&&e>=i},r=this.m_bars.findLast(s);if(null!==r)return r.index;const i=this.m_nsBars.findLast(s);return null!==i?i.index:this.m_bars.firstIndex()}if(s===r.FromLeft){const s=(s,r)=>{const i=r[t];return null!=i&&e<=i},r=this.m_bars.findFirst(s);if(null!==r)return r.index;const i=this.m_nsBars.findFirst(s);return null!==i?i.index:this.m_bars.lastIndex()}throw new Error("plotValueToTimePointIndex: unsupported search mode")}moveData(e){this._conflatedChunksBuilder.moveData(e),this.m_nsBars.move(e)}}},535422:(e,t,s)=>{s.d(t,{SeriesDataSource:()=>I,initialRequestOptionsToNumBars:()=>S,parseJapaneseProjectionBars:()=>C});var r=s(650151),i=s(536794),a=s(955722),n=s(477786),o=s(326488),l=s(359035),h=s(847774),d=s(547465);class c{constructor(){this._created=new d.Delegate,this._modified=new d.Delegate,this._loading=new d.Delegate,this._completed=new d.Delegate,this._error=new d.Delegate,this._symbolError=new d.Delegate,this._symbolResolved=new d.Delegate,this._seriesError=new d.Delegate,this._symbolNotPermitted=new d.Delegate,this._symbolInvalid=new d.Delegate,this._symbolGroupNotPermitted=new d.Delegate,this._chartTypeNotPermitted=new d.Delegate,this._intradaySpreadNotPermitted=new d.Delegate,this._intradayExchangeNotPermitted=new d.Delegate,this._customIntervalNotPermitted=new d.Delegate,this._secondsIntervalNotPermitted=new d.Delegate,this._ticksIntervalNotPermitted=new d.Delegate,this._barReceived=new d.Delegate,this._seriesTimeFrame=new d.Delegate,this._dataUpdated=new d.Delegate,this._unsupportedResolutionRequested=new d.Delegate}destroy(){this._created.destroy(),this._modified.destroy(),this._loading.destroy(),this._completed.destroy(),this._error.destroy(),this._symbolError.destroy(),this._symbolResolved.destroy(),this._seriesError.destroy(),this._symbolInvalid.destroy(),
this._symbolNotPermitted.destroy(),this._symbolGroupNotPermitted.destroy(),this._chartTypeNotPermitted.destroy(),this._intradaySpreadNotPermitted.destroy(),this._intradayExchangeNotPermitted.destroy(),this._customIntervalNotPermitted.destroy(),this._secondsIntervalNotPermitted.destroy(),this._ticksIntervalNotPermitted.destroy(),this._barReceived.destroy(),this._seriesTimeFrame.destroy(),this._dataUpdated.destroy(),this._unsupportedResolutionRequested.destroy()}created(){return this._created}modified(){return this._modified}loading(){return this._loading}completed(){return this._completed}error(){return this._error}symbolError(){return this._symbolError}symbolResolved(){return this._symbolResolved}seriesError(){return this._seriesError}symbolInvalid(){return this._symbolInvalid}symbolNotPermitted(){return this._symbolNotPermitted}symbolGroupNotPermitted(){return this._symbolGroupNotPermitted}chartTypeNotPermitted(){return this._chartTypeNotPermitted}intradaySpreadNotPermitted(){return this._intradaySpreadNotPermitted}intradayExchangeNotPermitted(){return this._intradayExchangeNotPermitted}customIntervalNotPermitted(){return this._customIntervalNotPermitted}secondsIntervalNotPermitted(){return this._secondsIntervalNotPermitted}ticksIntervalNotPermitted(){return this._ticksIntervalNotPermitted}barReceived(){return this._barReceived}seriesTimeFrame(){return this._seriesTimeFrame}dataUpdated(){return this._dataUpdated}unsupportedResolutionRequested(){return this._unsupportedResolutionRequested}fireCompleted(e){this._completed.fire(e)}fireCreated(e){this._created.fire(e)}fireModified(){this._modified.fire()}fireLoading(e){this._loading.fire(e)}fireError(){this._error.fire()}fireSymbolError(e){this._symbolError.fire(e),this.fireError()}fireSymbolResolved(e){this._symbolResolved.fire(e)}fireSeriesError(e){this._seriesError.fire(e),this.fireError()}fireSymbolInvalid(){this._symbolInvalid.fire()}fireSymbolNotPermitted(e){this._symbolNotPermitted.fire(e)}fireSymbolGroupNotPermitted(e){this._symbolGroupNotPermitted.fire(e)}fireChartTypeNotPermitted(e){this._chartTypeNotPermitted.fire(e),this.fireError()}fireIntradaySpreadNotPermitted(){this._intradaySpreadNotPermitted.fire(),this.fireError()}fireIntradayExchangeNotPermitted(){this._intradayExchangeNotPermitted.fire(),this.fireError()}fireCustomIntervalNotPermitted(e){this._customIntervalNotPermitted.fire(e),this.fireError()}fireSecondsIntervalNotPermitted(){this._secondsIntervalNotPermitted.fire(),this.fireError()}fireTicksIntervalNotPermitted(){this._ticksIntervalNotPermitted.fire(),this.fireError()}fireBarReceived(e){this._barReceived.fire(e)}fireSeriesTimeFrame(e,t,s,r,i){this._seriesTimeFrame.fire(e,t,s,r,i)}fireDataUpdated(e,t,s,r,i){this._dataUpdated.fire(e,t,s,r,i)}fireUnsupportedResolutionRequested(){this._unsupportedResolutionRequested.fire()}}var u=s(735566),_=s(670770),m=s(641208);const p=(0,u.getLogger)("Chart.SeriesDataSource");var f;!function(e){e[e.Idle=0]="Idle",e[e.AwaitingConnection=1]="AwaitingConnection",
e[e.AwaitingFirstDataUpdate=2]="AwaitingFirstDataUpdate",e[e.Active=3]="Active"}(f||(f={}));let y=1;let b=1;const g=300;function S(e){return e.startDate?e.endDate||e.count?e.endDate?["from_to",e.startDate,e.endDate]:["bar_count",e.startDate,(0,r.ensure)(e.count)]:["from_to",e.startDate]:e.count||g}function v(e){return(0,a.extractExtendedSymbol)(e).symbol}class I{constructor(e,t,s,r){this._extSymbol=null,this._lastResolvedSymbol="",this._createSeriesOverriddenParams=0,this._instanceId=null,this._symbolInstanceId=null,this._resolution=null,this._timeFrame=null,this._data=new o.SeriesData,this._dataEvents=new c,this._status=f.Idle,this._turnaroundCounter=1,this._boundOnGatewayIsConnectedChanged=this._onGatewayIsConnectedChanged.bind(this),this._ongoingDataUpdate=Promise.resolve(),this._gateway=e,this._turnaroundPrefix=t,this._createSeriesParams=S(s??{count:g}),this._timeFrame=r||null,this._gateway.isConnected().subscribe(this._boundOnGatewayIsConnectedChanged)}destroy(){this.stop(),this._gateway.isConnected().unsubscribe(this._boundOnGatewayIsConnectedChanged),this._dataEvents.destroy()}canModifySeries(e,t){const s=!(0,i.deepEquals)(this._extSymbol,e)[0],r=null===this._resolution||!n.Interval.isEqual(this._resolution,t);return s||r}modifySeries(e,t,s=null,o=!1,l=null){o&&(p.logNormal("Due to force flag clearing symbol & resolution to force re-requesting data."),this._extSymbol=null,this._resolution=null);const h=v(e),d=!this.symbolSameAsResolved(h);if(d&&(this._lastResolvedSymbol=""),this._extSymbol&&!d){const t=v(this._extSymbol);(0,a.replaceExtendedSymbol)(e,t)}const c=this._extSymbol,u=this._resolution;if(this._extSymbol=e,this._resolution=t,null===this._instanceId)return void(this._timeFrame=s);const _=!(0,i.deepEquals)(c,e)[0];_&&(0,a.replaceExtendedSymbol)(this._extSymbol,h);const m=null===u||!n.Interval.isEqual(u,t);(_||m||null!==s)&&(this._timeFrame=null,(_||m)&&this._turnaroundCounter++,_&&this._resolveSymbol(),this._gateway.modifySeries(this._instanceId,this.turnaround(),(0,r.ensureNotNull)(this._symbolInstanceId),this._resolution,l,s,this._onMessage.bind(this)),this._dataEvents.fireModified())}requestMoreData(e){null!==this._instanceId&&this._gateway.requestMoreData(this._instanceId,e,this._onMessage.bind(this))}requestMoreTickmarks(e){null!==this._instanceId&&this._gateway.requestMoreTickmarks(this._instanceId,e,this._onMessage.bind(this))}setFutureTickmarksMode(e){null!==this._instanceId&&this._gateway.setFutureTickmarksMode(e)}isStarted(){return this._status!==f.Idle}isActive(){return this._status===f.Active}resolution(){return this._resolution}start(){this.isStarted()?p.logNormal("start: data source is already started, nothing to do"):((0,r.assert)(null!==this._extSymbol,"symbol must be set before start"),(0,r.assert)(null!==this._resolution,"resolution must be set before start"),this._gateway.isConnected().value()?this._createSeries():this._changeStatusTo(f.AwaitingConnection))}stop(){this.isStarted()?(null!==this._instanceId&&(this._gateway.removeSeries(this._instanceId),this._instanceId=null),
this._symbolInstanceId=null,this._changeStatusTo(f.Idle)):p.logNormal("stop: data source is already stopped, nothing to do")}instanceId(){return this._instanceId}data(){return this._data}setData(e){this._data=e}setTimeframe(e){this._timeFrame=e}clearData(){this.isStarted()?this._enqueueUpdate((()=>this._clearDataImpl())):this._clearDataImpl()}dataEvents(){return this._dataEvents}turnaround(){return`${this._turnaroundPrefix}${this._turnaroundCounter}`}symbolInstanceId(){return this._symbolInstanceId}symbol(){return this._extSymbol}updateExtSymbol(e){this._extSymbol=e}moveData(e){return this._enqueueUpdate((()=>this._data.moveData(e)))}setInitialRequestOptions(e){this._createSeriesOverriddenParams=S(e)}symbolSameAsResolved(e){return null!==this._extSymbol&&(0,m.symbolSameAsResolved)(e,v(this._extSymbol),this._lastResolvedSymbol)}resolvedSymbol(){return null===this._extSymbol?null:v(this._extSymbol)}_resolveSymbol(){null!==this._extSymbol&&(this._symbolInstanceId=this._gateway.resolveSymbol("sds_sym_"+y++,(0,a.encodeExtendedSymbolOrGetSimpleSymbolString)(this._extSymbol),this._onMessage.bind(this)))}_clearDataImpl(){this._data.clear()}_changeStatusTo(e){(0,r.assert)(this._status!==e,"Source and destination status should be distinct"),p.logNormal(`Status changed from ${f[this._status]} to ${f[e]}`),this._status=e}_createSeries(){(0,r.assert)(this._status!==f.Active,'Status should not be "Active" when creating a study'),this._instanceId="sds_"+b++,this._resolveSymbol();const e=this._createSeriesOverriddenParams||this._createSeriesParams;this._createSeriesOverriddenParams&&(this._createSeriesOverriddenParams=0),this._gateway.createSeries(this._instanceId,this.turnaround(),(0,r.ensureNotNull)(this._symbolInstanceId),(0,r.ensureNotNull)(this._resolution),e,this._timeFrame,this._onMessage.bind(this)),this._timeFrame=null,this._changeStatusTo(f.AwaitingFirstDataUpdate),this._dataEvents.fireCreated(this._instanceId)}_onGatewayIsConnectedChanged(e){e?this._onGatewayConnected():this._onGatewayDisconnected()}_onGatewayConnected(){this._status===f.AwaitingConnection&&this._createSeries()}_onGatewayDisconnected(){this._status!==f.Idle&&this._status!==f.AwaitingConnection&&(this._instanceId=null,this._changeStatusTo(f.AwaitingConnection)),this._turnaroundCounter=1}_onMessage(e){this._enqueueUpdate((()=>this._onMessageImpl(e)))}async _onMessageImpl(e){switch(e.method){case"symbol_resolved":{const[t,s]=e.params;if(t!==this._symbolInstanceId){null!==this._symbolInstanceId&&p.logNormal(`Resolve for old symbol, expected: ${this._symbolInstanceId}, actual ${e.params[0]}`);break}this._onSymbolResolved(s);break}case"symbol_error":if(e.params[0]!==this._symbolInstanceId){null!==this._symbolInstanceId&&p.logNormal(`Symbol error for old symbol, expected: ${this._symbolInstanceId}, actual ${e.params[0]}`);break}this._onSymbolError(e);break;case"series_timeframe":{const[t,s,r,i,a,n,o]=e.params;if(!this._checkTurnaround(t,s)){p.logNormal(`Time frame for old data, expected: ${this._symbolInstanceId} (${this.turnaround()}), actual ${t} (${s})`)
;break}this._onSeriesTimeFrame(r,i,a,n,o);break}case"series_error":{const[t,s]=e.params;if(!this._checkTurnaround(t,s)){p.logNormal(`Series error for old data, expected: ${this._symbolInstanceId} (${this.turnaround()}), actual ${t} (${s})`);break}this._onSeriesError(e.params[2]);break}case"series_loading":{const[t,s]=e.params;if(!this._checkTurnaround(t,s))break;this._onSeriesLoading(e.time);break}case"series_completed":{const[t,s,r,i]=e.params;if(!this._checkTurnaround(t,r)){p.logNormal(`Series completed for old data, expected: ${this._symbolInstanceId} (${this.turnaround()}), actual ${t} (${r})`);break}this._onSeriesCompleted(s,e.time,i);break}case"data_update":if(!this._checkTurnaround(e.params.customId,e.params.turnaround)){p.logNormal(`Data update for old data, expected: ${this._symbolInstanceId} (${this.turnaround()}), actual ${e.params.customId} (${e.params.turnaround})`);break}await this._onDataUpdate(e.params.plots,e.params.nonseries,e.params.lastBar);break;case"clear_data":{if(e.params.turnaround!==this.turnaround()){p.logNormal(`Clear data for old data, expected: ${this.turnaround()}, actual ${e.params.turnaround}`);break}const t=this._data.first();this._clearDataImpl(),this._dataEvents.fireDataUpdated(void 0,!1,null,!1,t);break}}}_onSeriesError(e){let t,s;if("string"==typeof e)s={error:e},t=e;else if(s=e,e.ctx){const s={};Object.entries(e.ctx).forEach((([e,t])=>{s[e]=t.toString()})),t=e.error.format(s)}else t=e.error;if(t.startsWith("study_not_auth:")){const e=t.split(":",2)[1].split("@",2)[0];if(["BarSetRenko","BarSetPriceBreak","BarSetKagi","BarSetPnF"].includes(e))this._dataEvents.fireChartTypeNotPermitted(e);else{if("BarSetSpread"===e)return void this._dataEvents.fireIntradaySpreadNotPermitted();if("BarSetRange"===e){const e=`${(0,r.ensureNotNull)(this._extSymbol).inputs.range}R`;this._dataEvents.fireCustomIntervalNotPermitted(e)}}}else{if(t.startsWith("unsupported"))return void this._dataEvents.fireUnsupportedResolutionRequested();"resolution_not_entitled"===t?this._dataEvents.fireIntradayExchangeNotPermitted():"custom_resolution"===t?this._dataEvents.fireCustomIntervalNotPermitted((0,r.ensureNotNull)(this._resolution)):"seconds_not_entitled"===t?this._dataEvents.fireSecondsIntervalNotPermitted():"ticks_not_entitled"===t&&this._dataEvents.fireTicksIntervalNotPermitted()}this._dataEvents.fireSeriesError(s)}_onSeriesTimeFrame(e,t,s,r,i){this._dataEvents.fireSeriesTimeFrame(e,t,s,r??!0,i)}_onSymbolError(e){if(e.params[1]===h.permissionDenied)switch(e.params[2]){case h.SymbolErrorPermissionDeniedReason.Symbol:this._dataEvents.fireSymbolNotPermitted(e.params[3]);break;case h.SymbolErrorPermissionDeniedReason.GroupPermission:this._dataEvents.fireSymbolGroupNotPermitted(e.params[3]);break;default:this._dataEvents.fireSymbolNotPermitted(e.params[2])}else e.params[1]===h.invalidSymbol&&this._dataEvents.fireSymbolInvalid();this._dataEvents.fireSymbolError(e.params[1])}_onSymbolResolved(e){this._lastResolvedSymbol=(0,r.ensureNotNull)((0,_.extractSymbolNameFromSymbolInfo)(e,"")),
this._dataEvents.fireSymbolResolved(e)}async _onDataUpdate(e,t,s){this._onDataUnpacked(e,s,await C(t))}_enqueueUpdate(e){return this._ongoingDataUpdate=this._ongoingDataUpdate.then(e,e),this._ongoingDataUpdate}_onDataUnpacked(e,t,s){if(this._status===f.Idle)return;this._status===f.AwaitingFirstDataUpdate&&(this._changeStatusTo(f.Active),this._clearDataImpl());const r=this._data.bars().size(),i=this._data.first(),a=this._data.bars().firstIndex(),n=this._data.mergeRegularBars(e);null!==s&&(this._data.nsBars().clear(),this._data.nsBars().merge(s.projectionPlots),this._data.lastProjectionPrice=s.lastPrice,null!==s.boxSize&&(this._data.boxSize=s.boxSize),this._data.reversalAmount=s.reversalAmount);const o=null===a,l=o||null!==n&&n.index<a;this._dataEvents.fireDataUpdated(t,l,n,o,i),r!==this._data.bars().size()&&null!==n&&this._dataEvents.fireBarReceived(n)}_onSeriesLoading(e){this._dataEvents.fireLoading(e)}_onSeriesCompleted(e,t,s){this._dataEvents.fireCompleted({updateMode:e,time:t,flags:s})}_checkTurnaround(e,t){return this._instanceId===e&&(void 0===t||t===this.turnaround())}}async function C(e){if(void 0===e)return{projectionPlots:[],boxSize:null};if(""===e.d||"nochange"===e.indexes)return null;const t=await(0,l.unpackNonSeriesData)(e.d);if(null===t||t.indexes_replace)return null;const s=e.indexes,{bars:r,price:i,boxSize:a,reversalAmount:n}=t.data;return{lastPrice:i,projectionPlots:(r||[]).map((e=>{let t;return"factor"in e?t=e.factor:"additionalPrice"in e&&(t=e.additionalPrice),{index:s[e.time],value:[0,e.open,e.high,e.low,e.close,e.volume,t]}})),reversalAmount:n,boxSize:a}}},641208:(e,t,s)=>{function r(e,t,s){return e===t||e===s}s.d(t,{symbolSameAsResolved:()=>r})},707771:(e,t,s)=>{s.d(t,{INVALID_TIME_POINT_INDEX:()=>r,UNPLOTTABLE_TIME_POINT_INDEX:()=>i});const r=-2e6,i=-1e6}}]);